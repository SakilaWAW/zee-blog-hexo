---
layout: post
title: "本地静态文件调试远程接口的设计"
date: 2020-09-15 16:48:54 +0800
categories: 计算机网络
banner_img: /images/local-static-remote-api-proxy/banner.jpg
index_img: /images/local-static-remote-api-proxy/banner.jpg
tags: [https, nodejs, proxy]
---

> 由于涉及公司项目，本篇文章只介绍设计没有代码，如果按照这个思路实现的话，代码不会超过100行，请各位看官自行实现-. -

#### 一、前言

最近在开发的过程中发现一个痛点，花费了一些时间来解决。以本文记录一下思考和解决问题的过程。

#### 二、痛点与思考

规模大一些的公司，由于部门众多，员工编码安全意识薄弱，可能会出现内部系统信息泄露，操作权限混乱等安全问题。现在普遍的做法是安全团队提供多种检测手段、各业务自行配置ACL等、部分业务禁止对公网访问等来规避风险。

但这样可能衍生一个问题: 本地dev服务器可能会有一些接口无法访问，以至于不能在本地完全模拟线上环境。举个例子，如果本地获取用户身份信息接口不通的话，有些权限配置的开发就不好调试。这对我们的开发是及其不友好的。

所以**如果能做一个工具让我们在调试的时候可以直接调用线上所有接口，但是静态文件又都是本地的，那当真是极好的。**

#### 三、设计

如何做到这一点呢？很简单，我们做一个代理服务器做数据分发就可以了，地址如果为静态资源就分发到本地dev server，如果是api接口就调用远程接口，这样的话api权限什么的都不用处理，因为网站的host就是线上的。请看图:

![系统结构图](/images/local-static-remote-api-proxy/system-design.png)

整体来说就是加两个代理服务器，一个代理做隧道，另一个https代理进行请求的分发。
下面分步解读下:

① 本机浏览器通过switchyOmega这个chrome插件将所有需要代理的域名请求映射到http代理服务器上

② http代理服务器接到请求后通过隧道代理技术将所有请求流入到https代理服务器中，隧道代理的原理请看[这篇文章](https://imququ.com/post/web-proxy.html)

③ https代理服务器接到请求后解析url和host，将接口请求分发到线上环境，将其他请求分发到本地Dev server中，这个https服务器使用的方式就是[前面那篇文章](https://imququ.com/post/web-proxy.html)中的普通代理模式

④ https代理服务器将请求的返回内容返回到http代理

⑤ http代理只是个隧道，会将内容传回浏览器，完

了解了基本原理之后使用任何后台语言都可以开发，我是使用的nodejs，全部代码80多行，相信你如果看懂了过程也可以自己开发出来。

开发完成后使用的过程为:
开启switchyOmega(第一次用得配置)->开启我们的两个代理服务器->访问线上网址
也可以关闭switchyOmega直接切换到本机的开发环境

由于vue是通过长连接来实现热刷新的，所以通过这种代理的方法也可以达到本地更改后自动刷新网页看效果，很方便。

#### 四、注意的点

整个过程需要注意的是由于https代理使用https协议，所以需要配置相应的证书，并且需要让本机信任对应的CA证书。有关https协议的基础知识看[这篇文章](https://zhuanlan.zhihu.com/p/57142784)，关于如何用openssl签发证书与本篇文章关联不大，会单写篇文章说明。

另外使用了这种方法后由于接口是线上数据，可不要轻易的做增删改的操作。

#### 五、结语

主要思路已经写得比较清晰了，其实这个工具在公司里还是非常常用的，当初做调研的时候发现网上的文章良莠不齐，比较杂乱，经过几天的思考和学习把这个东西设计并实现出来。希望这篇文章能给大家讲明白。
